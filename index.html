<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curso BlatoRH Group - Offboarding de Consultores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); box-shadow: 0 0 12px rgba(251, 191, 36, 0.5); }
            50% { transform: scale(1.03); box-shadow: 0 0 24px rgba(251, 191, 36, 0.8); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a192f;
            color: #e6f1ff;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
        }
        .app-container {
            width: 100%;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .card {
            background-color: rgba(17, 34, 64, 0.85);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(136, 146, 176, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: all 0.3s ease;
            animation: fadeIn 0.6s ease-out forwards;
        }
        .btn { @apply font-bold py-3 px-6 rounded-lg transition-all duration-300 ease-in-out transform focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900; }
        .btn-primary { @apply bg-amber-400 text-slate-900 hover:bg-amber-300 focus:ring-amber-400 shadow-lg shadow-amber-500/20; }
        .btn-primary:disabled { @apply bg-amber-800 text-slate-400 cursor-not-allowed transform-none shadow-none; }
        .btn-secondary { @apply bg-slate-700 text-white hover:bg-slate-600 focus:ring-slate-500; }
        .pulsing-button { animation: pulse-glow 2.5s infinite ease-in-out; }
        .input-field {
            background-color: #1e293b;
            border: 2px solid #334155;
            color: #e2e8f0;
            @apply mt-2 block w-full px-4 py-3 rounded-lg shadow-sm transition-all duration-300;
        }
        .input-field:focus { @apply outline-none ring-2 ring-amber-400 border-amber-400 bg-slate-900; }
        .progress-bar-container { @apply w-full bg-slate-700 rounded-full h-3 overflow-hidden; }
        .progress-bar { @apply bg-amber-400 h-3 rounded-full transition-all duration-500 ease-out; }
        #chapter-content { max-height: 55vh; overflow-y: auto; padding-right: 1rem; scroll-behavior: smooth; }
        #chapter-content::-webkit-scrollbar { width: 8px; }
        #chapter-content::-webkit-scrollbar-track { background: #1e293b; border-radius: 10px; }
        #chapter-content::-webkit-scrollbar-thumb { background: #fbbF24; border-radius: 10px; }
        #chapter-content::-webkit-scrollbar-thumb:hover { background: #f59e0b; }
        .quiz-option {
            background-color: #1e293b;
            border: 2px solid #334155;
            @apply flex items-center w-full text-left p-4 rounded-lg cursor-pointer hover:bg-slate-700 hover:border-amber-400 transition-all duration-200 transform hover:scale-102;
        }
        .quiz-option.selected { border-color: #fbbF24; background-color: #334155; transform: scale(1.02); }
        .hidden { display: none; }
        .screen { width: 100%; }

        /* New Login Screen Styles */
        .login-grid {
            display: grid;
            grid-template-columns: 1fr;
            min-height: 100vh;
        }
        @media (min-width: 1024px) {
            .login-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        .login-promo {
            background: linear-gradient(-45deg, #0a192f, #172a46, #4a0e99, #23d5ab);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            padding: 2rem;
        }

        /* Diploma Styles */
        #diploma-content {
            background-color: #fdfbf4;
            color: #3a2d0d;
            border: 10px solid #c5a358;
            padding: 2rem;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            background-image: url('data:image/svg+xml,%3Csvg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-48 0c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48-25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7z" fill="%23d4b979" fill-opacity="0.1"/%3E%3C/svg%3E');
        }
        .diploma-title { font-family: 'Playfair Display', serif; color: #8c6b22; }
        .diploma-text { font-family: 'Merriweather', serif; }
        .diploma-seal {
            position: absolute;
            bottom: 3.5rem;
            right: 2.5rem;
            width: 100px;
            height: 100px;
            background: radial-gradient(ellipse at center, #d4af37 0%,#b48811 100%);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.5), inset 0 0 5px rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .diploma-seal-inner {
            width: 80px;
            height: 80px;
            border: 2px solid #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
        }
        .signature-line {
            border-top: 2px solid #8c6b22;
            width: 250px;
            margin-top: 3rem;
        }
        .signature-text { font-family: 'Merriweather', serif; font-style: italic; }
    </style>
</head>
<body class="antialiased">
    
    <header id="app-header" class="w-full max-w-5xl mx-auto p-4 md:p-6 hidden">
        <div class="flex items-center space-x-3">
            <svg class="h-10 w-10 text-amber-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.008h-.008v-.008z" />
            </svg>
            <span class="text-2xl font-bold text-white">BlatoRH Group</span>
        </div>
    </header>

    <main class="app-container">
        <div class="main-content-area w-full">

            <div id="diploma-loading" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center">
                <div class="text-center p-6 bg-slate-800 rounded-xl">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-amber-500 mx-auto mb-4"></div>
                    <p class="text-white">Generando diploma...</p>
                </div>
            </div>

            <div id="message-box" class="fixed top-5 left-1/2 -translate-x-1/2 mt-4 p-4 rounded-lg shadow-lg text-white z-50 hidden" role="alert">
                <span id="message-text"></span>
                <button onclick="document.getElementById('message-box').classList.add('hidden')" class="ml-4 font-bold">&times;</button>
            </div>

            <div id="login-screen" class="screen w-full min-h-screen">
                <div class="login-grid">
                    <div class="login-promo hidden lg:flex flex-col justify-center items-start p-12">
                         <img src="./blatorh.png" alt="BlatoRH Logo" class="h-16 w-auto mb-8" onerror="this.src='https://placehold.co/200x64/FFFFFF/0a192f?text=BlatoRH'; this.onerror=null;">
                        <h1 class="text-5xl font-bold text-white leading-tight mt-4">Procedimiento de Offboarding para Consultores</h1>
                        <p class="text-slate-300 mt-4 text-lg">Asegurar una transición ordenada y segura es clave. Esta capacitación te guiará en cada paso del proceso de offboarding.</p>
                    </div>
                    <div class="flex flex-col justify-center items-center p-8 bg-slate-900/50">
                        <div class="w-full max-w-md">
                             <div class="text-center lg:hidden mb-8">
                                <h2 class="text-3xl md:text-4xl font-bold text-white">BlatoRH Group</h2>
                                <p class="mt-2 text-slate-300">Offboarding de Consultores</p>
                             </div>
                            <p class="text-center text-slate-300 mb-2">Ingresa tus datos para comenzar.</p>
                            <div class="text-center mb-6">
                                <div class="inline-flex items-center bg-slate-800/50 px-3 py-1.5 rounded-full text-sm">
                                    <svg class="w-5 h-5 mr-2 text-amber-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>
                                    <span id="course-duration-estimate"></span>
                                </div>
                            </div>
                            <form id="login-form" class="space-y-6">
                                <div>
                                    <label for="name" class="block text-sm font-medium text-slate-300">Nombre</label>
                                    <input type="text" id="name" class="input-field" required>
                                </div>
                                <div>
                                    <label for="surname" class="block text-sm font-medium text-slate-300">Apellido</label>
                                    <input type="text" id="surname" class="input-field" required>
                                </div>
                                <div>
                                    <label for="email" class="block text-sm font-medium text-slate-300">Email Corporativo</label>
                                    <input type="email" id="email" class="input-field" required pattern=".*@blatorh\.com$">
                                </div>
                                <button type="submit" id="login-submit-btn" class="btn btn-primary w-full !mt-8 pulsing-button">
                                    <span class="btn-text">Ingresar al Curso</span>
                                    <span class="btn-loader hidden animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-slate-900 mx-auto"></span>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div id="course-screen" class="card screen hidden w-full max-w-3xl mx-auto">
                <div class="mb-6">
                    <p id="chapter-number" class="text-amber-400 font-semibold"></p>
                    <h2 id="chapter-title" class="text-3xl md:text-4xl font-bold mt-1"></h2>
                </div>
                <div class="progress-bar-container mb-6">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
                <div id="chapter-content" class="prose prose-invert max-w-none text-slate-300 text-lg leading-relaxed"></div>
                <div class="flex flex-col sm:flex-row justify-between items-center mt-8 border-t border-slate-700 pt-6 space-y-4 sm:space-y-0">
                    <button id="listen-btn" class="btn btn-secondary w-full sm:w-auto">Escuchar Audio</button>
                    <button id="next-btn" class="btn btn-primary w-full sm:w-auto" disabled>Siguiente</button>
                </div>
            </div>

            <div id="quiz-screen" class="card screen hidden w-full max-w-2xl mx-auto">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold">Evaluación Final</h2>
                    <p class="text-slate-300 mt-1">Demuestra lo que has aprendido.</p>
                </div>
                <div class="progress-bar-container my-6">
                    <div id="quiz-progress-bar" class="progress-bar"></div>
                </div>
                <div id="quiz-content" class="min-h-[30vh]"></div>
                <div id="quiz-navigation" class="flex justify-between items-center mt-8">
                    <button id="prev-question-btn" class="btn btn-secondary">Anterior</button>
                    <button id="next-question-btn" class="btn btn-primary">Siguiente</button>
                </div>
                 <button id="submit-quiz-btn" class="btn btn-primary w-full mt-8 hidden">Finalizar y Ver Resultados</button>
            </div>
            
            <div id="result-screen" class="card screen hidden text-center w-full max-w-md mx-auto">
                 <h2 class="text-3xl font-bold mb-4">Resultados</h2>
                 <p class="text-6xl font-bold mb-4" id="result-score"></p>
                 <p class="text-xl mb-8" id="result-message"></p>
                 <div id="result-summary" class="space-y-2 text-left max-w-md mx-auto mb-8"></div>
                 <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <button id="restart-quiz-btn" class="btn btn-secondary">Reintentar</button>
                    <button id="diploma-btn" class="btn btn-primary hidden">Ver Diploma</button>
                 </div>
            </div>

            <div id="diploma-screen" class="card screen hidden w-full max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold mb-6 text-center">¡Felicitaciones, has completado el curso!</h2>
                <div id="diploma-content-wrapper" class="p-2 bg-slate-800 rounded-lg">
                    <div id="diploma-content">
                        <div class="text-center">
                            <p class="diploma-text text-xl">Certificado de Finalización</p>
                            <h1 class="diploma-title text-5xl my-4">DIPLOMA</h1>
                            <p class="diploma-text text-lg">Este certificado es otorgado a:</p>
                            <p class="diploma-text text-4xl font-bold my-6" id="diploma-participant-name" style="font-family: 'Playfair Display', serif;"></p>
                            <p class="diploma-text text-lg">Por haber completado exitosamente el curso:</p>
                            <p class="diploma-text text-2xl font-bold my-4">"Procedimiento de Offboarding para Consultores"</p>
                            <p class="diploma-text text-lg">Otorgado en la fecha:</p>
                            <p class="diploma-text text-xl font-semibold" id="diploma-date"></p>
                        </div>
                        <div class="flex justify-center mt-8">
                            <div class="text-center">
                                <p class="signature-text text-2xl">BlatoRH Group</p>
                                <div class="signature-line"></div>
                                <p class="diploma-text font-bold">Firma Autorizada</p>
                            </div>
                        </div>
                        <div class="diploma-seal">
                            <div class="diploma-seal-inner">CURSO APROBADO</div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row justify-center mt-8 space-y-4 sm:space-y-0 sm:space-x-4">
                    <button id="download-diploma-btn" class="btn btn-primary">Descargar Diploma (PDF)</button>
                    <button onclick="downloadResourcePdf()" class="btn btn-secondary">Descargar Material (PDF)</button>
                    <button id="restart-course-btn" class="btn btn-secondary">Reiniciar Curso</button>
                </div>
            </div>

            <div id="admin-panel" class="card screen hidden w-full max-w-4xl mx-auto">
                 <h2 class="text-2xl font-bold mb-6 text-center">Panel de Administración</h2>
                 <button id="export-csv-btn" class="btn btn-primary mb-4">Exportar Aprobados (CSV)</button>
                 <div class="overflow-x-auto">
                     <table class="min-w-full bg-slate-800 rounded-lg shadow-md">
                         <thead class="bg-slate-700 text-slate-300 uppercase text-sm leading-normal">
                             <tr>
                                 <th class="py-3 px-6 text-left">Nombre</th>
                                 <th class="py-3 px-6 text-left">Apellido</th>
                                 <th class="py-3 px-6 text-left">Email</th>
                                 <th class="py-3 px-6 text-left">Score</th>
                                 <th class="py-3 px-6 text-left">Fecha</th>
                             </tr>
                         </thead>
                         <tbody id="approved-users-table-body" class="text-slate-400 text-sm font-light"></tbody>
                     </table>
                 </div>
            </div>

        </div>
    </main>

    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://zaxyokejvwupwmbhenso.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpheHlva2Vqdnd1cHdtYmhlbnNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NzMwNDYsImV4cCI6MjA2ODQ0OTA0Nn0.boNwgjYadjo6deO_YfKbLCGt0ug4H012D2KuhX0WZB8';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const COURSE_TITLE = "Procedimiento de Offboarding para Consultores";

        // DOM Elements
        const appHeader = document.getElementById('app-header');
        const screens = {
            login: document.getElementById('login-screen'),
            course: document.getElementById('course-screen'),
            quiz: document.getElementById('quiz-screen'),
            result: document.getElementById('result-screen'),
            diploma: document.getElementById('diploma-screen'),
            admin: document.getElementById('admin-panel'),
        };
        const loginForm = document.getElementById('login-form');
        const loginSubmitBtn = document.getElementById('login-submit-btn');
        const nameInput = document.getElementById('name');
        const surnameInput = document.getElementById('surname');
        const emailInput = document.getElementById('email');
        const courseDurationEstimate = document.getElementById('course-duration-estimate');
        const chapterNumberDisplay = document.getElementById('chapter-number');
        const progressBar = document.getElementById('progress-bar');
        // ¡CORRECCIÓN! Posible typo: document = document.getElementById('chapter-title')
        // Debería ser: const chapterTitleDisplay = document.getElementById('chapter-title');
        const chapterTitleDisplay = document.getElementById('chapter-title'); // ¡CORREGIDO!
        const chapterContentDisplay = document.getElementById('chapter-content');
        const listenBtn = document.getElementById('listen-btn');
        const nextBtn = document.getElementById('next-btn');
        const quizProgressBar = document.getElementById('quiz-progress-bar');
        const quizContent = document.getElementById('quiz-content');
        const prevQuestionBtn = document.getElementById('prev-question-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const submitQuizBtn = document.getElementById('submit-quiz-btn');
        const resultScore = document.getElementById('result-score');
        const resultMessage = document.getElementById('result-message');
        const resultSummary = document.getElementById('result-summary');
        const restartQuizBtn = document.getElementById('restart-quiz-btn');
        const diplomaBtn = document.getElementById('diploma-btn');
        const diplomaParticipantName = document.getElementById('diploma-participant-name');
        const diplomaDate = document.getElementById('diploma-date');
        const downloadDiplomaBtn = document.getElementById('download-diploma-btn');
        const restartCourseBtn = document.getElementById('restart-course-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const approvedUsersTableBody = document.getElementById('approved-users-table-body');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const diplomaLoading = document.getElementById('diploma-loading');

        // State
        let currentUser = null;
        let currentChapterIndex = 0;
        let currentQuestionIndex = 0;
        let speechQueue = [];
        let wasManuallyStopped = false;
        let selectedVoice = null;
        let userAnswers = new Array(5).fill(null);
        let autoPlayTimeout = null;

        // Data
        const chapters = [
            { title: "Notificación de Terminación", content: `<p><strong>Confirmación de la Terminación:</strong> Recursos Humanos notifica al consultor sobre la terminación del contrato, indicando la fecha final de trabajo.</p><p class="mt-4"><strong>Revisión de documentación:</strong> El consultor debe proporcionar cualquier documentación pendiente y completar formularios requeridos por Recursos Humanos.</p><p class="mt-4"><strong>Comunicación al Equipo:</strong> El líder de proyecto informa al equipo sobre la salida del consultor, asegurando una transición fluida.</p>`},
            { title: "Devolución de Equipos y Accesos", content: `<p><strong>Devolución de Equipos:</strong> El consultor debe devolver todo el equipo proporcionado por la empresa (computadora, teléfono, etc.) en buen estado.</p><p class="mt-4"><strong>Revocación de Accesos:</strong> El área de IT revoca todos los accesos a sistemas internos, correo electrónico, VPN y cualquier otro sistema utilizado por el consultor.</p>`},
            { title: "Transferencia de Conocimientos y Proyectos", content: `<p><strong>Documentación de Proyectos:</strong> El consultor debe documentar el estado de los proyectos en curso, asegurando que toda la información relevante esté accesible para el equipo.</p><p class="mt-4"><strong>Reunión de Transferencia:</strong> Se organiza una reunión entre el consultor saliente, el líder de proyecto y cualquier otro miembro relevante del equipo para transferir conocimientos clave.</p>`},
            { title: "Liquidación Final y Beneficios", content: `<p><strong>Liquidación de Pagos:</strong> Recursos Humanos y Finanzas procesan la liquidación final del consultor, incluyendo cualquier pago pendiente de honorarios, vacaciones no utilizadas y otros beneficios acumulados.</p>`},
            { title: "Entrevista de Salida", content: `<p><strong>Entrevista de Salida:</strong> Recursos Humanos organiza una entrevista de salida para recibir feedback del consultor sobre su experiencia en Blatorh Group y posibles áreas de mejora.</p>`},
            { title: "Cumplimiento de Acuerdos de Confidencialidad", content: `<p><strong>Recordatorio del NDA:</strong> Recursos Humanos recuerda al consultor sobre el cumplimiento continuo del Acuerdo de Confidencialidad (NDA) incluso después de su salida.</p><p class="mt-4"><strong>Firma de Declaración:</strong> El consultor firma una declaración final confirmando que no retiene ninguna información confidencial ni propiedad intelectual de la empresa.</p>`}
        ];
        const quizQuestions = [
            { question: "¿Quién notifica al consultor sobre la terminación de su contrato?", options: ["El líder de proyecto", "Un compañero de equipo", "Recursos Humanos", "El área de Finanzas"], answer: 2 },
            { question: "¿Qué área es responsable de revocar los accesos a los sistemas internos?", options: ["El consultor mismo", "El área de IT", "Recursos Humanos", "El líder de proyecto"], answer: 1 },
            { question: "¿Cuál es el propósito de la reunión de transferencia?", options: ["Discutir la liquidación final", "Devolver el equipo de la empresa", "Transferir conocimientos clave al equipo", "Realizar la entrevista de salida"], answer: 2 },
            { question: "¿Quién organiza la entrevista de salida con el consultor?", options: ["El área de Finanzas", "El líder de proyecto", "El área de IT", "Recursos Humanos"], answer: 3 },
            { question: "¿Qué debe firmar el consultor al final del proceso para confirmar que no retiene información sensible?", options: ["Un nuevo contrato", "Una declaración de confidencialidad", "Un formulario de devolución de equipos", "La liquidación final"], answer: 1 }
        ];
        
        // Functions
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => {
                if (screen && !screen.classList.contains('hidden')) screen.classList.add('hidden');
            });
            if (screens[screenName]) screens[screenName].classList.remove('hidden');
            
            if (screenName !== 'login') {
                appHeader.classList.remove('hidden');
            } else {
                appHeader.classList.add('hidden');
            }
        }

        function showMessage(message, type) {
            messageText.textContent = message;
            messageBox.className = `fixed top-5 left-1/2 -translate-x-1/2 mt-4 p-4 rounded-lg shadow-lg text-white z-50 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => { messageBox.classList.add('hidden'); }, 5000); 
        }

        async function saveUserProgressToSupabase(user) {
            const { data, error } = await supabaseClient
                .from('users_progress')
                .upsert({ 
                    id: user.id,
                    name: user.name || '',
                    surname: user.surname || '',
                    email: user.email,
                    course_title: user.course_title,
                    progress: user.progress || 0,
                    quiz_score: user.quizScore || null,
                    completed_date: user.completed_date || null,
                    approved: user.approved || false
                }, { onConflict: 'id' }); // onConflict: 'id' es válido si el id es la PK para este registro de progreso

            if (error) {
                console.error('Error guardando progreso:', error.message);
                showMessage('Error guardando progreso: ' + error.message, 'error');
                throw error;
            } else {
                console.log('Progreso guardado.');
            }
        }

        // ¡MODIFICADO! Esta función ahora no se usa en initializeApp directamente,
        // la lógica se movió para buscar por email y course_title.
        // Se mantiene por si se usa en otro lugar, pero su llamado ha sido ajustado.
        async function loadUserProgressFromSupabase(userId) {
            const { data, error } = await supabaseClient
                .from('users_progress')
                .select('*')
                .eq('id', userId)
                .single();

            if (error && error.code !== 'PGRST116') { // PGRST116 = No row found
                console.error('Error cargando progreso por userId:', error.message);
                // No mostrar mensaje de error si no se encuentra la fila (es un comportamiento esperado)
                return null;
            }
            return data;
        }

        function updateProgressBar() {
            const progress = ((currentChapterIndex + 1) / chapters.length) * 100;
            progressBar.style.width = `${progress}%`;
            if (currentUser) {
                currentUser.progress = currentChapterIndex;
                saveUserProgressToSupabase(currentUser).catch(err => console.error("Failed to save progress on update", err));
            }
        }
        
        function calculateCourseDuration() {
            let wordCount = 0;
            chapters.forEach(chapter => {
                const strippedContent = chapter.content.replace(/<[^>]*>/g, '');
                wordCount += strippedContent.split(/\s+/).length;
            });
            const readingTimeInMinutes = wordCount / 200;
            const extraTime = readingTimeInMinutes * 0.10;
            const totalContentDuration = readingTimeInMinutes + extraTime;
            const quizTime = quizQuestions.length * 1; 
            const finalDuration = totalContentDuration + quizTime;
            return Math.ceil(finalDuration);
        }
        
        function loadChapter() {
            if (autoPlayTimeout) clearTimeout(autoPlayTimeout);
            
            if (currentChapterIndex < chapters.length) {
                const chapter = chapters[currentChapterIndex];
                chapterNumberDisplay.textContent = `Capítulo ${currentChapterIndex + 1} de ${chapters.length}`;
                chapterTitleDisplay.textContent = chapter.title;
                chapterContentDisplay.innerHTML = chapter.content;
                
                nextBtn.disabled = true;
                nextBtn.classList.remove('pulsing-button');
                listenBtn.textContent = "Escuchar Audio";
                
                updateProgressBar();

                autoPlayTimeout = setTimeout(() => {
                    handleListen();
                }, 7000);
            } else {
                startQuiz();
            }
        }
        
        function loadAndSetVoice() {
            const voices = window.speechSynthesis.getVoices();
            let voicePriority = voices.find(voice => voice.lang.startsWith('es-') && (voice.name.includes('Female') || voice.name.includes('Femenino') || voice.name.includes('Mujer')));
            selectedVoice = voicePriority || voices.find(voice => voice.lang.startsWith('es-'));
        }

        function speakNextInQueue() {
            if (wasManuallyStopped || speechQueue.length === 0) {
                listenBtn.textContent = "Escuchar Audio";
                if (!wasManuallyStopped) {
                    nextBtn.disabled = false;
                    nextBtn.classList.add('pulsing-button');
                }
                speechQueue = [];
                return;
            }
            const { utterance } = speechQueue.shift();
            if(selectedVoice) utterance.voice = selectedVoice;
            utterance.onend = speakNextInQueue;
            window.speechSynthesis.speak(utterance);
        }

        function handleListen() {
            if (autoPlayTimeout) clearTimeout(autoPlayTimeout);
            
            if (window.speechSynthesis.speaking) {
                wasManuallyStopped = true;
                speechQueue = [];
                window.speechSynthesis.cancel();
                return;
            }
            
            wasManuallyStopped = false;
            listenBtn.textContent = "Detener Audio";
            
            speechQueue = [];
            const elementsToRead = [chapterTitleDisplay, ...chapterContentDisplay.children];
            
            elementsToRead.forEach(element => {
                const text = element.textContent.trim();
                if (text) {
                    const sentences = text.match(/[^.!?]+[.!?]*/g) || [];
                    sentences.forEach(sentenceText => {
                        const trimmedSentence = sentenceText.trim();
                        if (trimmedSentence) {
                            const utterance = new SpeechSynthesisUtterance(trimmedSentence);
                            utterance.lang = 'es-ES';
                            speechQueue.push({ utterance });
                        }
                    });
                }
            });

            speakNextInQueue();
        }

        function startQuiz() {
            showScreen('quiz');
            currentQuestionIndex = 0;
            userAnswers = new Array(quizQuestions.length).fill(null);
            renderQuestion();
        }
        
        function renderQuestion() {
            const q = quizQuestions[currentQuestionIndex];
            quizContent.innerHTML = `
                <p class="font-semibold text-xl text-center text-slate-200 mb-8">${currentQuestionIndex + 1}. ${q.question}</p>
                <div class="flex flex-col space-y-4">
                    ${q.options.map((option, index) => `
                        <button class="quiz-option" data-answer-index="${index}">
                            <span class="text-amber-400 font-bold mr-4">${String.fromCharCode(65 + index)}</span>
                            <span class="flex-1">${option}</span>
                        </button>
                    `).join('')}
                </div>
            `;

            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const selectedIndex = parseInt(e.currentTarget.dataset.answerIndex);
                    userAnswers[currentQuestionIndex] = selectedIndex;
                    document.querySelectorAll('.quiz-option').forEach(b => b.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                    updateQuizNavigation();
                });
            });

            if (userAnswers[currentQuestionIndex] !== null) {
                const selectedBtn = quizContent.querySelector(`.quiz-option[data-answer-index="${userAnswers[currentQuestionIndex]}"]`);
                if (selectedBtn) selectedBtn.classList.add('selected');
            }

            updateQuizNavigation();
            updateQuizProgressBar();
        }

        function updateQuizNavigation() {
            prevQuestionBtn.style.visibility = currentQuestionIndex === 0 ? 'hidden' : 'visible';
            const isLastQuestion = currentQuestionIndex === quizQuestions.length - 1;
            nextQuestionBtn.classList.toggle('hidden', isLastQuestion);
            submitQuizBtn.classList.toggle('hidden', !isLastQuestion);
            
            const answerSelected = userAnswers[currentQuestionIndex] !== null;
            nextQuestionBtn.disabled = !answerSelected;
            submitQuizBtn.disabled = !answerSelected;
        }

        function updateQuizProgressBar() {
            const progress = ((currentQuestionIndex + 1) / quizQuestions.length) * 100;
            quizProgressBar.style.width = `${progress}%`;
        }
        
        async function submitQuiz() {
            let correctAnswers = 0;
            userAnswers.forEach((answer, index) => {
                if (answer === quizQuestions[index].answer) correctAnswers++;
            });
            const score = Math.round((correctAnswers / quizQuestions.length) * 100);
            
            if (currentUser) {
                currentUser.quizScore = score;
                currentUser.completed_date = new Date().toLocaleDateString('es-AR');
                currentUser.approved = score >= 80;
                await saveUserProgressToSupabase(currentUser);
            }
            showResultScreen(score);
        }
        
        function showResultScreen(score) {
            showScreen('result');
            resultScore.textContent = `${score}%`;
            resultMessage.textContent = score >= 80 ? '¡Excelente! Has aprobado.' : 'Necesitas repasar. ¡Inténtalo de nuevo!';
            diplomaBtn.classList.toggle('hidden', score < 80);
            resultSummary.innerHTML = quizQuestions.map((q, i) => {
                const isCorrect = userAnswers[i] === q.answer;
                return `<div class="flex items-center text-sm ${isCorrect ? 'text-green-400' : 'text-red-400'}">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">${isCorrect ? '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />' : '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />'}</svg>
                    <span>Pregunta ${i+1}: ${isCorrect ? 'Correcta' : 'Incorrecta'}</span>
                </div>`;
            }).join('');
        }

        async function initializeApp() {
            if ('speechSynthesis' in window) {
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = loadAndSetVoice;
                } else {
                    loadAndSetVoice();
                }
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const adminMode = urlParams.get('admin') === 'true';
            
            if (adminMode) {
                showScreen('admin');
                loadApprovedUsers();
            } else {
                // ¡MODIFICADO! Intentar cargar el último email y course_title usados desde localStorage
                const storedEmail = localStorage.getItem('blatorh_course_email'); // ¡NUEVO!
                const storedCourseTitle = localStorage.getItem('blatorh_course_title'); // ¡NUEVO!

                // Si encontramos tanto el email como el course_title en localStorage, intentamos cargar el progreso
                if (storedEmail && storedCourseTitle === COURSE_TITLE) { // ¡MODIFICADO! Verificar si es el mismo curso
                    try {
                        const { data: userDataFromDB, error: loadError } = await supabaseClient
                            .from('users_progress')
                            .select('*')
                            .eq('email', storedEmail) // ¡MODIFICADO! Buscar por email
                            .eq('course_title', COURSE_TITLE) // ¡MODIFICADO! Y por el título del curso actual
                            .single();

                        if (loadError && loadError.code !== 'PGRST116') { // PGRST116 = No row found
                            throw loadError;
                        }
                        
                        if (userDataFromDB) {
                            currentUser = { ...userDataFromDB };
                            // Precargar los campos del formulario con los datos cargados
                            nameInput.value = currentUser.name || ''; // ¡NUEVO!
                            surnameInput.value = currentUser.surname || ''; // ¡NUEVO!
                            emailInput.value = currentUser.email || ''; // ¡NUEVO!

                            if (currentUser.approved) {
                                showScreen('diploma');
                                updateDiplomaContent();
                            } else {
                                showScreen('course');
                                currentChapterIndex = currentUser.progress || 0;
                                loadChapter();
                            }
                        } else {
                            // Si no se encuentra un registro para el email Y el curso actual,
                            // o si el 'storedCourseTitle' no es para el curso actual,
                            // o si el storedUserId no existe para este curso (aunque ya no lo usamos para la búsqueda principal aquí)
                            // limpia el localStorage y muestra la pantalla de login.
                            localStorage.removeItem('blatorh_course_email'); // ¡MODIFICADO!
                            localStorage.removeItem('blatorh_course_title'); // ¡MODIFICADO!
                            showScreen('login');
                        }
                    } catch (err) {
                        console.error('Error cargando progreso al inicio:', err);
                        showMessage('Error al cargar tu progreso. Por favor, intenta iniciar sesión de nuevo.', 'error');
                        localStorage.removeItem('blatorh_course_email'); // ¡MODIFICADO!
                        localStorage.removeItem('blatorh_course_title'); // ¡MODIFICADO!
                        showScreen('login');
                    }
                } else {
                    // Si no hay datos en localStorage para este curso, o es un curso diferente,
                    // mostrar la pantalla de login.
                    showScreen('login');
                    courseDurationEstimate.textContent = `Duración: ${calculateCourseDuration()} min`;
                }
            }
        }
        
        function updateDiplomaContent() {
             if (currentUser) {
                diplomaParticipantName.textContent = `${currentUser.name || ''} ${currentUser.surname || ''}`.trim();
                diplomaDate.textContent = currentUser.completed_date;
            }
        }

        async function downloadDiploma() {
            diplomaLoading.classList.remove('hidden');
            downloadDiplomaBtn.disabled = true;
            
            const { jsPDF } = window.jspdf;
            const diplomaContent = document.getElementById('diploma-content');
            try {
                const canvas = await html2canvas(diplomaContent, { scale: 3, backgroundColor: '#fdfbf4' });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(`Diploma_BlatoRH_${currentUser.name}_${currentUser.surname}_${COURSE_TITLE.replace(/\s/g, '_')}.pdf`); // ¡MODIFICADO! Nombre de archivo más específico
            } catch (error) {
                showMessage('Error al generar el diploma en PDF.', 'error');
            } finally {
                diplomaLoading.classList.add('hidden');
                downloadDiplomaBtn.disabled = false;
            }
        }
        
        async function restartCourse(fullRestart = true) {
             if (fullRestart) {
                // ¡MODIFICADO! Eliminar solo los datos de este curso del localStorage
                localStorage.removeItem('blatorh_course_email');
                localStorage.removeItem('blatorh_course_title');
                currentUser = null;
                window.location.reload();
             } else {
                startQuiz();
             }
        }
        
        async function loadApprovedUsers() {
            const { data: users, error } = await supabaseClient
                .from('users_progress')
                .select('*')
                .eq('approved', true);

            if (error) {
                console.error('Error cargando usuarios aprobados:', error.message);
                showMessage('Error cargando usuarios aprobados.', 'error');
                return;
            }

            approvedUsersTableBody.innerHTML = '';
            if (users.length === 0) {
                approvedUsersTableBody.innerHTML = '<tr><td colspan="5" class="py-3 px-6 text-center">No hay usuarios aprobados aún.</td></tr>';
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-slate-700', 'hover:bg-slate-700');
                row.innerHTML = `
                    <td class="py-3 px-6 text-left whitespace-nowrap">${user.name || ''}</td>
                    <td class="py-3 px-6 text-left whitespace-nowrap">${user.surname || ''}</td>
                    <td class="py-3 px-6 text-left whitespace-nowrap">${user.email}</td>
                    <td class="py-3 px-6 text-left">${user.quiz_score ? user.quiz_score.toFixed(0) + '%' : 'N/A'}</td>
                    <td class="py-3 px-6 text-left whitespace-nowrap">${user.completed_date || 'N/A'}</td>
                `;
                approvedUsersTableBody.appendChild(row);
            });
        }
        
        function exportApprovedUsersToCsv() {
            const users = Array.from(approvedUsersTableBody.rows).map(row => ({
                name: row.cells[0].textContent,
                surname: row.cells[1].textContent,
                email: row.cells[2].textContent,
                quizScore: row.cells[3].textContent,
                completedDate: row.cells[4].textContent // Mantengo completedDate aquí si el exportador lo espera así
            }));

            if (users.length === 0 || (users.length === 1 && users[0].name === 'No hay usuarios aprobados aún.')) {
                showMessage('No hay usuarios aprobados para exportar.', 'error');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Nombre,Apellido,Email,Score,Fecha de Finalización\n";

            users.forEach(user => {
                const row = [ user.name, user.surname, user.email, user.quizScore, user.completedDate ].map(item => `"${item}"`).join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "usuarios_aprobados_blatorh.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function downloadResourcePdf() {
            try {
                const pdfUrl = 'https://raw.githubusercontent.com/BLHTR/CursoSeguridad/main/Procedimiento%20para%20el%20Reporte%20de%20Incidentes%20de%20Seguridad.pdf';
                window.open(pdfUrl, '_blank');
            } catch (error) {
                showMessage('Error al abrir el PDF del curso.', 'error');
            }
        }

        // Event Listeners
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            loginSubmitBtn.disabled = true;
            loginSubmitBtn.querySelector('.btn-text').classList.add('hidden');
            loginSubmitBtn.querySelector('.btn-loader').classList.remove('hidden');

            const name = nameInput.value.trim();
            const surname = surnameInput.value.trim();
            const email = emailInput.value.trim();

            try {
                // ¡MODIFICADO! Buscar usuario por email Y course_title
                const { data: existingUser, error: findError } = await supabaseClient
                    .from('users_progress')
                    .select('id, progress, approved, name, surname, completed_date, quiz_score') // Asegúrate de obtener todos los campos necesarios
                    .eq('email', email)
                    .eq('course_title', COURSE_TITLE) // ¡CLAVE! Filtrar por el título del curso actual
                    .single();

                if (findError && findError.code !== 'PGRST116') { // PGRST116 = No row found (esto es esperado si no existe)
                    throw findError; // Otros errores sí son problemáticos
                }

                if (existingUser) {
                    // Si el usuario existe para ESTE curso, cargamos sus datos existentes
                    currentUser = {
                        ...existingUser,
                        // Forzar la actualización de nombre y apellido si el usuario los cambia en el formulario
                        name: name,
                        surname: surname,
                        email: email, // Asegurar que el email actual se use
                        course_title: COURSE_TITLE // Asegurar que el título del curso sea el actual
                    };
                } else {
                    // Si no existe un registro para ESTE usuario Y ESTE curso, creamos uno nuevo
                    currentUser = {
                        id: crypto.randomUUID(), // Generamos un nuevo ID UUID
                        name: name,
                        surname: surname,
                        email: email,
                        course_title: COURSE_TITLE,
                        progress: 0,
                        quizScore: null,
                        completed_date: null,
                        approved: false
                    };
                }

                // Guardar/Actualizar el progreso del usuario en Supabase
                // onConflict: ['email', 'course_title'] es más robusto si quieres que el UPSERT sepa que esos campos son únicos.
                // Sin embargo, como el 'id' es PK, 'onConflict: 'id'' está bien si el ID ya se maneja en el frontend de forma única por curso.
                // Pero si hay conflictos lógicos, el `id` generará nuevos registros si la combinación email/course_title ya tiene un id diferente.
                // Con la restricción UNIQUE en DB, esto es menos crítico, ya que la DB lo impedirá.
                await saveUserProgressToSupabase(currentUser);

                // ¡MODIFICADO! Almacenar email y course_title en localStorage en lugar de solo userId
                localStorage.setItem('blatorh_course_email', currentUser.email);
                localStorage.setItem('blatorh_course_title', currentUser.course_title); // ¡NUEVO!

                if (currentUser.approved && currentUser.course_title === COURSE_TITLE) { // ¡MODIFICADO! Doble check para el diploma
                    showScreen('diploma');
                    updateDiplomaContent();
                } else {
                    showScreen('course');
                    currentChapterIndex = currentUser.progress || 0;
                    loadChapter();
                }

            } catch (err) {
                console.error('Error en el ingreso:', err);
                // Si el error es una violación de restricción única (por ejemplo, si se intenta insertar un duplicado de email/course_title
                // que no fue capturado por la lógica existingUser por algún motivo), mostrar un mensaje más específico.
                const errorMessage = err.message || 'Ocurrió un problema al conectar con la base de datos. Revisa las políticas de seguridad (RLS) en Supabase o la consola del navegador para más detalles.';
                if (err.code === '23505') { // Código de error SQL para violación de restricción única
                     showMessage(`Error: Ya existe un registro para este email en este curso.`, 'error');
                } else {
                    showMessage(`Error: ${errorMessage}`, 'error');
                }
            } finally {
                loginSubmitBtn.disabled = false;
                loginSubmitBtn.querySelector('.btn-text').classList.remove('hidden');
                loginSubmitBtn.querySelector('.btn-loader').classList.add('hidden');
            }
        });

        listenBtn.addEventListener('click', handleListen);
        
        nextBtn.addEventListener('click', () => { 
            if (window.speechSynthesis.speaking) {
                wasManuallyStopped = true;
                speechQueue = [];
                window.speechSynthesis.cancel();
            }
            currentChapterIndex++; 
            loadChapter(); 
        });

        prevQuestionBtn.addEventListener('click', () => { 
            if(currentQuestionIndex > 0) { 
                currentQuestionIndex--; 
                renderQuestion(); 
            } 
        });
        nextQuestionBtn.addEventListener('click', () => { 
            if(userAnswers[currentQuestionIndex] !== null && currentQuestionIndex < quizQuestions.length - 1) { 
                currentQuestionIndex++; 
                renderQuestion(); 
            }
        });
        submitQuizBtn.addEventListener('click', submitQuiz);
        restartQuizBtn.addEventListener('click', () => restartCourse(false));
        diplomaBtn.addEventListener('click', () => { showScreen('diploma'); updateDiplomaContent(); });
        downloadDiplomaBtn.addEventListener('click', downloadDiploma);
        restartCourseBtn.addEventListener('click', () => restartCourse(true));
        exportCsvBtn.addEventListener('click', exportApprovedUsersToCsv);
        
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>